<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game - Partie en cours</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="script.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .board-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .game-info {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-width: 300px;
        }

        .player-info {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
        }

        .player-info.active {
            background: #e3f2fd;
        }

        .chat-container {
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .chat-input button {
            padding: 8px 16px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .chat-input button:hover {
            background: #34495e;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            text-align: center;
        }

        .move-history {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .move-history h3 {
            margin-bottom: 10px;
        }

        .move-history ul {
            list-style: none;
        }

        .move-history li {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        /* Styles pour le plateau d'échecs */
        #chessboard {
            width: 560px;
            height: 560px;
            border: 2px solid #333;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
        }

        .square {
            width: 70px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            font-size: 40px;
        }

        .square.white {
            background-color: #f0d9b5;
        }

        .square.black {
            background-color: #b58863;
        }

        .square.selected {
            background-color: #7b61ff;
        }

        .piece {
            width: 60px;
            height: 60px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Styles pour les pièces blanches */
        .piece.white-pawn {
            background-image: url('./images/turtle_white.jpg');
        }

        .piece.white-rook {
            background-image: url('./images/Tiger Trident_0 white.png');
        }

        .piece.white-knight {
            background-image: url('./images/elephant_white.jpg');
        }

        .piece.white-bishop {
            background-image: url('./images/eagle_white.jpg');
        }

        .piece.white-queen {
            background-image: url('./images/archer_white.png');
        }

        .piece.white-king {
            background-image: url('./images/archer_white.png');
        }

        /* Styles pour les pièces noires */
        .piece.black-pawn {
            background-image: url('./images/turtle_black.jpg');
        }

        .piece.black-rook {
            background-image: url('./images/Tiger Trident_0 black.png');
        }

        .piece.black-knight {
            background-image: url('./images/elephant_black.jpg');
        }

        .piece.black-bishop {
            background-image: url('./images/eagle_black.jpg');
        }

        .piece.black-queen {
            background-image: url('./images/archer_black.png');
        }

        .piece.black-king {
            background-image: url('./images/archer_black.png');
        }

        .waiting-room {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .waiting-room h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .game-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .game-actions button {
            padding: 12px 20px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .game-actions button:hover {
            background: #34495e;
        }

        .join-game {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .join-game input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .join-game button {
            padding: 12px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .join-game button:hover {
            background: #219a52;
        }

        .game-link {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .game-link p {
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: bold;
        }

        .game-link input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 16px;
            background: white;
        }

        .game-link button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .game-link button:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <h1>Partie d'échecs en cours</h1>
    
    <div class="game-container">
        <div class="board-container">
            <div id="chessboard">
                <!-- Les cases seront générées par JavaScript -->
            </div>
            <div class="board-controls">
                <button id="resign-button" onclick="resignGame()">Abandonner</button>
                <button id="draw-button" onclick="offerDraw()">Proposer la nulle</button>
            </div>
        </div>

        <div class="game-info">
            <div id="waiting-room" class="waiting-room">
                <h3>Créer ou rejoindre une partie</h3>
                <div class="game-actions">
                    <button onclick="createNewGame()" style="background: #e74c3c;">Créer une nouvelle partie</button>
                    <div class="join-game">
                        <input type="text" id="game-id-input" placeholder="Entrez l'ID de la partie">
                        <button onclick="joinGame()">Rejoindre</button>
                    </div>
                </div>
                <div id="game-link" class="game-link" style="display: none;">
                    <p>Partagez ce lien avec votre adversaire :</p>
                    <input type="text" id="game-url" readonly>
                    <button onclick="copyGameLink()">Copier le lien</button>
                </div>
            </div>
            <div id="player1" class="player-info">
                <h3>Joueur 1 (Blancs)</h3>
                <p id="player1-name">En attente...</p>
                <p id="player1-time">Temps: 10:00</p>
            </div>
            <div id="player2" class="player-info">
                <h3>Joueur 2 (Noirs)</h3>
                <p id="player2-name">En attente...</p>
                <p id="player2-time">Temps: 10:00</p>
            </div>
            <div id="game-status">
                <p>En attente d'un adversaire...</p>
            </div>
            <div id="error-message" class="error-message"></div>
            <div class="move-history">
                <h3>Historique des coups</h3>
                <ul id="moves-list"></ul>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <h3>Chat</h3>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Votre message...">
            <button onclick="sendMessage()">Envoyer</button>
        </div>
    </div>

    <script>
        // Connexion au serveur WebSocket
        const socket = io();
        let gameId = null;
        let username = localStorage.getItem('username') || 'Joueur';
        let selectedPiece = null;
        let isMyTurn = false;

        // Récupérer le token JWT du localStorage
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // Authentification avec le serveur
        socket.on('connect', () => {
            console.log('Connecté au serveur');
            socket.emit('authenticate', token);
        });

        // Gestionnaire d'événements pour l'authentification
        socket.on('authenticated', () => {
            console.log('Authentification réussie');
            // Créer une nouvelle partie ou rejoindre une partie existante
            const urlParams = new URLSearchParams(window.location.search);
            const joinGameId = urlParams.get('gameId');
            
            if (joinGameId) {
                socket.emit('joinGame', { gameId: joinGameId, username });
            }
        });

        // Gestionnaire pour la création d'une partie
        socket.on('gameCreated', ({ gameId: newGameId }) => {
            console.log('Partie créée avec l\'ID:', newGameId);
            gameId = newGameId;
            const gameUrl = `${window.location.origin}/game.html?gameId=${gameId}`;
            document.getElementById('game-url').value = gameUrl;
            document.getElementById('game-link').style.display = 'block';
            document.getElementById('game-status').textContent = 'En attente d\'un adversaire...';
        });

        // Gestionnaire pour le début d'une partie
        socket.on('gameStart', ({ color, opponent }) => {
            console.log('La partie commence ! Couleur:', color, 'Adversaire:', opponent);
            document.getElementById('waiting-room').style.display = 'none';
            document.getElementById('game-status').textContent = `La partie a commencé ! Vous jouez les ${color === 'white' ? 'blancs' : 'noirs'}`;
            document.getElementById('player2-name').textContent = opponent;
            isMyTurn = color === 'white';
        });

        // Gestionnaire pour les mises à jour du jeu
        socket.on('gameUpdate', ({ gameState }) => {
            updateGameState(gameState);
            updateBoard(gameState.board);
            updateMoveHistory(gameState.moves);
        });

        // Gestionnaire pour la déconnexion d'un joueur
        socket.on('playerDisconnected', () => {
            document.getElementById('game-status').textContent = 'L\'adversaire s\'est déconnecté';
        });

        // Gestionnaire pour les erreurs
        socket.on('error', (message) => {
            console.error('Erreur:', message);
            showError(message);
        });

        // Fonction pour mettre à jour l'état du jeu
        function updateGameState(gameState) {
            const player1 = gameState.players[0];
            const player2 = gameState.players[1];

            document.getElementById('player1-name').textContent = player1.username;
            if (player2) {
                document.getElementById('player2-name').textContent = player2.username;
            }

            // Mettre à jour l'indication du tour actuel
            document.getElementById('player1').classList.toggle('active', gameState.currentTurn === 'white');
            document.getElementById('player2').classList.toggle('active', gameState.currentTurn === 'black');

            // Mettre à jour l'état du tour du joueur
            const playerIndex = gameState.players.findIndex(p => p.id === socket.id);
            isMyTurn = (playerIndex === 0 && gameState.currentTurn === 'white') ||
                       (playerIndex === 1 && gameState.currentTurn === 'black');
        }

        // Fonction pour mettre à jour le plateau
        function updateBoard(board) {
            // Nettoyer le plateau
            const chessboard = document.getElementById('chessboard');
            chessboard.innerHTML = '';

            // Créer le plateau
            for (let row = 8; row >= 1; row--) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    const file = String.fromCharCode(97 + col);
                    const rank = row;
                    const position = `${file}${rank}`;
                    
                    square.className = `square ${(row + col) % 2 === 0 ? 'white' : 'black'}`;
                    square.dataset.position = position;
                    
                    // Ajouter la pièce si elle existe
                    const piece = board[position];
                    if (piece) {
                        const pieceElement = document.createElement('div');
                        pieceElement.className = `piece ${piece.color} ${piece.type}`;
                        square.appendChild(pieceElement);
                    }

                    // Ajouter les gestionnaires d'événements
                    square.addEventListener('click', () => handleSquareClick(position));
                    
                    chessboard.appendChild(square);
                }
            }
        }

        // Fonction pour gérer les clics sur les cases
        function handleSquareClick(position) {
            if (!isMyTurn) return;

            if (!selectedPiece) {
                const piece = document.querySelector(`[data-position="${position}"] .piece`);
                if (piece) {
                    selectedPiece = position;
                    document.querySelector(`[data-position="${position}"]`).classList.add('selected');
                }
            } else {
                if (selectedPiece !== position) {
                    makeMove(selectedPiece, position);
                }
                document.querySelector(`[data-position="${selectedPiece}"]`).classList.remove('selected');
                selectedPiece = null;
            }
        }

        // Fonction pour mettre à jour l'historique des coups
        function updateMoveHistory(moves) {
            const movesList = document.getElementById('moves-list');
            movesList.innerHTML = '';
            
            moves.forEach((move, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${move.piece.color} ${move.piece.type}: ${move.from} → ${move.to}`;
                movesList.appendChild(li);
            });
        }

        // Fonction pour envoyer un message dans le chat
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message) {
                socket.emit('chatMessage', {
                    gameId,
                    message,
                    username
                });
                input.value = '';
            }
        }

        // Gestionnaire pour les messages du chat
        socket.on('chatMessage', ({ username, message }) => {
            const chatMessages = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.textContent = `${username}: ${message}`;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // Gestionnaire pour les mouvements des pièces
        function makeMove(from, to) {
            socket.emit('makeMove', {
                gameId,
                from,
                to
            });
        }

        // Fonctions pour les contrôles du jeu
        function resignGame() {
            if (confirm('Êtes-vous sûr de vouloir abandonner la partie ?')) {
                socket.emit('resign');
            }
        }

        function offerDraw() {
            socket.emit('drawOffer');
        }

        // Événements Socket.IO pour les contrôles du jeu
        socket.on('drawOffer', (data) => {
            if (confirm(`${data.username} propose la nulle. Acceptez-vous ?`)) {
                socket.emit('drawResponse', true);
            } else {
                socket.emit('drawResponse', false);
            }
        });

        socket.on('gameOver', (data) => {
            document.getElementById('game-status').textContent = `Partie terminée : ${data.reason}`;
            document.getElementById('resign-button').disabled = true;
            document.getElementById('draw-button').disabled = true;
        });

        // Fonction pour créer une nouvelle partie
        function createNewGame() {
            console.log('Création d\'une nouvelle partie...');
            socket.emit('createGame', username);
        }

        // Fonction pour rejoindre une partie
        function joinGame() {
            const gameId = document.getElementById('game-id-input').value.trim();
            if (gameId) {
                console.log('Tentative de rejoindre la partie:', gameId);
                socket.emit('joinGame', { gameId, username });
            } else {
                showError('Veuillez entrer un ID de partie valide');
            }
        }

        // Fonction pour copier le lien de la partie
        function copyGameLink() {
            const gameUrl = document.getElementById('game-url');
            gameUrl.select();
            document.execCommand('copy');
            showError('Lien copié !');
        }

        // Fonction pour afficher une erreur
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            setTimeout(() => {
                errorElement.textContent = '';
            }, 3000);
        }

        // Vérifier si on rejoint une partie existante
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinGameId = urlParams.get('gameId');
            
            if (joinGameId) {
                document.getElementById('game-id-input').value = joinGameId;
                joinGame();
            }
        };
    </script>
</body>
</html> 